<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="天明的小窝">
<meta property="og:url" content="http://litianming1024.github.io/index.html">
<meta property="og:site_name" content="天明的小窝">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="天明的小窝">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://litianming1024.github.io/"/>





  <title>天明的小窝</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '106956825-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">天明的小窝</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2018/09/24/限流算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/限流算法/" itemprop="url">限流算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-24T17:57:32+08:00">
                2018-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/09/24/限流算法/" class="leancloud_visitors" data-flag-title="限流算法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上周是收获最多的一周，先是被大佬套路如何排查问题，之后又一脚踩进Go的坑中，最后又见识了用户各种薅羊毛的路数。在系统设计中，通常要要秉承两条原则：</p>
<ul>
<li>上层保护下层，作为主调方要从参数，流量等保护下层接口，面对架构复杂即使不能保护下层接口，也要有保护的意识</li>
<li>下层不信任上层，作为被调方要对接收的参数验证，来源验证，防止被恶意攻击。在内部系统中参数还好控制，一旦暴露在外部，什么牛鬼蛇神都能传进来。要强调一句对于基本数据类型的范围一定要有一个认识，不只是2的n次方-1什么的，<strong>而是要具体到大约多少亿范围</strong>。在工作中发生过调用方传超出范围的字符串，而调用integer.parseint抛出runtime exception但没有方法catch导致调用超时无数据返回的情况。无数据返回在RPC调用中非常致命，只能等超时返回，严重降低并发。也就是说<strong>只要调用必须控制超时时间，执行异常必须返回信息，不能等待超时断开连接返回空</strong>。</li>
</ul>
<p>高并发系统中有三种常见方式来保护系统：缓存、降级和限流。缓存和降级在<a href="https://litianming1024.github.io/2018/09/02/%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E7%B3%BB%E5%88%97/">缓存使用系列</a>讲过了，这回来讲限流算法。</p>
<p>常见的限流地方有：限制并发总数（数据库连接池、线程池、单ip并发数）、限制瞬时并发数、限制时间窗口内的平均速率等等。</p>
<h2 id="1-限流算法"><a href="#1-限流算法" class="headerlink" title="1. 限流算法"></a>1. 限流算法</h2><h3 id="1-1-漏桶算法（leaky-bucket）"><a href="#1-1-漏桶算法（leaky-bucket）" class="headerlink" title="1.1 漏桶算法（leaky bucket）"></a>1.1 漏桶算法（leaky bucket）</h3><p>漏桶作为计量工具时，可以用于流量整形和流量控制，漏桶算法的描述如下：</p>
<ul>
<li>容量固定，按照固定速率流出水滴</li>
<li>如果桶为空，则不流出水滴</li>
<li>可以按照任意速率流入水滴到漏桶</li>
<li>如果流入水滴超出了桶的容量，流入的水滴被丢弃，桶的容量不变<img src="/2018/09/24/限流算法/Leaky_bucket_analogy.jpg" alt="Leaky_bucket_analogy.jpg" title="">
图来自维基百科</li>
</ul>
<h3 id="1-2-令牌桶算法（token-bucket）"><a href="#1-2-令牌桶算法（token-bucket）" class="headerlink" title="1.2 令牌桶算法（token bucket）"></a>1.2 令牌桶算法（token bucket）</h3><p>令牌桶算法是存放固定容量令牌的桶，按照固定速率往桶里添加令牌。令牌桶算法的描述如下：</p>
<ul>
<li>每 1/r 秒往桶中添加一个令牌</li>
<li>桶中最多存放b个令牌，当桶满时新添加的令牌被丢弃</li>
<li>当n个字节的数据包到达时<ul>
<li>如果桶中存在多于n个令牌，删除n个令牌，将数据包发送到网络上</li>
<li>不足n个令牌，不会删除令牌，数据包被丢弃或者放入缓冲区<img src="/2018/09/24/限流算法/令牌桶.png" alt="令牌桶.png" title="">
图来自参考1</li>
</ul>
</li>
</ul>
<p>漏桶算法和令牌桶算法的区别：</p>
<ul>
<li>令牌桶算法允许一定程度的并发，只要桶中有令牌就可以。漏桶法通过限制常量流出速率从而平滑流入速率</li>
<li>两个算法的实现可以一样，但是方向是相反的，对于相同参数得到的限流效果是一样的</li>
</ul>
<h3 id="1-2-计数器法和滑动窗口法"><a href="#1-2-计数器法和滑动窗口法" class="headerlink" title="1.2 计数器法和滑动窗口法"></a>1.2 计数器法和滑动窗口法</h3><p>计数器法相对其它算法是最容易实现的，当然各种场景下的计数器法都有致命问题，GC中的计数难以处理循环引用，这里的计数器面对临界值也有问题。比如我们统计1分钟内的访问次数，限制最多为100，每次有请求计数器加一，如果59秒时来了100个请求，1分钟时又来了100个请求，相当于2秒内来了200个请求，超出限制。有什么解决办法呢？想一想有什么协议也需要控制流量，TCP！TCP中的滑动窗口就是很好的实现方式。这里不再写了。可以参考链接里的第二篇</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://jinnianshilongnian.iteye.com/blog/2305117" target="_blank" rel="external">并发系统之限流特技</a><br><a href="http://www.kissyu.org/2016/08/13/%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/" target="_blank" rel="external">接口限流算法总结</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2018/09/18/应用服务器性能优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/应用服务器性能优化/" itemprop="url">应用服务器性能优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-18T00:44:48+08:00">
                2018-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/09/18/应用服务器性能优化/" class="leancloud_visitors" data-flag-title="应用服务器性能优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网站的业务逻辑都部署在应用服务器上，是主要优化的地方，优化的常见方式是缓存、集群、异步等。</p>
<h2 id="1-分布式缓存"><a href="#1-分布式缓存" class="headerlink" title="1.分布式缓存"></a>1.分布式缓存</h2><p>缓存的使用无处不在，ORM框架中的多级缓存，MVC框架中的模板缓存，浏览器缓存，几乎任何框架都提供了缓存功能。</p>
<blockquote>
<p>网站性能优化第一定律：优先考虑使用缓存优化性能</p>
</blockquote>
<h3 id="1-1-缓存的基本原理"><a href="#1-1-缓存的基本原理" class="headerlink" title="1.1 缓存的基本原理"></a>1.1 缓存的基本原理</h3><p>简单而言都是KV，即Key-Value形式，在这之上有Key-Key-Value形式（Redis的Sorted Set，TODO：Redis数据结构实现原理），用的最多还是KV。KV中的Value是二进制安全的。</p>
<p>Java中的hashCode方法可以得到hashcode，这里要说的知识点很多，equals和hashCode任一方法重写都需要重写，准确的说是必须，不然会影响集合类的使用。null对象也是有哈希值的，是0！只有HashTable直接使用hashCode的值，其余都会再扰动计算。只有HashMap允许key或者value为空情况出现，ConcurrentHashMap和淘汰的HashTable都不允许，因为多线程环境无法区分key是put时为null还是key不存在，而且null作为key很容易受到攻击。SynchronizedMap因为可以包装HashMap而可以支持，但是原理和HashTable一样，锁粒度太大导致性能都很差。（TODO：Java并发集合）</p>
<h3 id="1-2-合理使用缓存"><a href="#1-2-合理使用缓存" class="headerlink" title="1.2 合理使用缓存"></a>1.2 合理使用缓存</h3><ul>
<li>频繁修改的数据不适用缓存：读写比小于2：1</li>
<li>热点访问数据适合缓存：尽量保证缓存高频访问的数据</li>
<li>数据不一致与脏读：设置合理的缓存更新策略，一般为缓存设置失效时间</li>
<li>缓存可用性：保证缓存服务的稳定，通过分布式集群等</li>
<li>缓存预热：针对热点数据缓存，比如利用LRU算法等需要较长时间，可以提前人工加载热点数据</li>
<li>缓存穿透、缓存雪崩、缓存击穿：使用缓存的经典问题，见<a href="https://litianming1024.github.io/2018/09/02/缓存使用系列">缓存使用</a></li>
</ul>
<h3 id="1-3-分布式缓存"><a href="#1-3-分布式缓存" class="headerlink" title="1.3 分布式缓存"></a>1.3 分布式缓存</h3><p>分布式缓存指缓存部署在多个服务器组成的集群中，以集群方式提供缓存服务，其架构方式有两种。一种是以JBoss Cache为代表的需要更新同步的分布式缓存，一种是以Memcached为代表的不互相通信的分布式缓存（TODO：Memcached以后填坑）。</p>
<h2 id="2-异步操作"><a href="#2-异步操作" class="headerlink" title="2. 异步操作"></a>2. 异步操作</h2><p>很多情况下使用异步操作可以改善网站性能，使用消息队列的常见作用就是削峰填谷，将部分操作异步避免前面业务的等待，同时要注意不要把所有后续业务的处理都放在单一的业务逻辑中。如注册后的发邮件就可以放入消息队列，后续处理交由邮件发送消费者。使用消息队列要注意重放攻击，对于哪些操作能放入消息队列，生产者处理失败如何处理要有规定。</p>
<blockquote>
<p>任何可以晚点做的事情都应该晚点再做</p>
</blockquote>
<h2 id="3-使用集群"><a href="#3-使用集群" class="headerlink" title="3. 使用集群"></a>3. 使用集群</h2><p>在高并发场景下使用负载均衡技术，通过多台服务器为应用构建集群是最简单的方式。请求太多怎么办，上机器！单一的机器受各种限制，配合微服务使用应用集群能够有效处理并发。</p>
<h2 id="4-代码优化"><a href="#4-代码优化" class="headerlink" title="4. 代码优化"></a>4. 代码优化</h2><p>代码写的烂再多的机器都不一定能救。不同代码的优化方式有别，诸如Java从Web容器，ORM框架选择，JDK本身的优化，JVM调优等。</p>
<h3 id="4-1-多线程"><a href="#4-1-多线程" class="headerlink" title="4.1 多线程"></a>4.1 多线程</h3><p>多线程是基本的措施，但要考虑<strong>线程安全</strong>问题。使用多线程的原因主要是<strong>IO阻塞</strong>与<strong>多CPU</strong>，当线程进行IO处理时会被阻塞，这时CPU会被释放可以调度其它线程。</p>
<p>网站的应用程序都是被Web服务器容器管理，不论时Web服务器容器管理的线程还是应用程序自己创建的线程，都不易过多，线程切换虽然比进程切换快，但是过多的线程会带来调度问题。通常启动的线程数：</p>
<p>启动线程数＝［任务执行时间/（任务执行时间（IO等待时间）］］* CPU内核数</p>
<p>最佳启动线程数和CPU内核数量成正比，和IO阻塞时间成反比。</p>
<p>多线程带来线程安全问题，常见的解决手段有，我会单独写一片effective java读后感（TODO：线程安全）：</p>
<ul>
<li>对象设计为无状态：无状态对象肯定时线程安全的</li>
<li>使用局部对象：被多线程访问的对象会出现可见性问题，因为工作内存中的对象是共享内存的拷贝</li>
<li>并发访问资源使用锁：强一致性要加锁，并合理降低锁的粒度</li>
<li>防止对象逸出：切勿将内部对象返回给外部</li>
</ul>
<h3 id="4-2-资源复用"><a href="#4-2-资源复用" class="headerlink" title="4.2 资源复用"></a>4.2 资源复用</h3><p>资源复用常见的是单例模式和对象池。对象池有许多种类，如数据库连接池、线程池，如何设计一个线程池也是有趣的问题（TODO：线程池设计），要考虑核心线程池大小、最大大小、阻塞队列设计（有限无限）、拒绝策略、线程存活时间（长时间未使用要回收）。</p>
<h3 id="4-3-数据结构"><a href="#4-3-数据结构" class="headerlink" title="4.3 数据结构"></a>4.3 数据结构</h3><p>优化存储结构，合理使用Redis的存储类型，选择合适的MySQl引擎</p>
<h3 id="4-4-垃圾回收"><a href="#4-4-垃圾回收" class="headerlink" title="4.4 垃圾回收"></a>4.4 垃圾回收</h3><p>如Java中要对JVM调优和内存泄漏，这里经验不多，改日填坑（TODO：JVM调优）</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>《大型网站技术架构:核心原理与案例分析》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2018/09/11/Web前端性能优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/11/Web前端性能优化/" itemprop="url">Web前端性能优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-11T02:22:27+08:00">
                2018-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/09/11/Web前端性能优化/" class="leancloud_visitors" data-flag-title="Web前端性能优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>作为后端，也要经常和前端对需求，前端的优化也要了解，同时对于HTTP协议也要有一定的认识（TODO：HTTP协议）。</p>
<h2 id="1-浏览器访问优化"><a href="#1-浏览器访问优化" class="headerlink" title="1. 浏览器访问优化"></a>1. 浏览器访问优化</h2><h3 id="1-1-减少http请求"><a href="#1-1-减少http请求" class="headerlink" title="1.1 减少http请求"></a>1.1 减少http请求</h3><p>HTTP协议是<strong>基于TCP的无状态应用层协议</strong>，每次HTTP请求都要建立通信链路进行数据传输，服务器端则要启动独立的线程来处理（实际上Servlet容器都是使用线程池复用连接；高并发情况下我们也会使用各种手段过滤重复的请求，比如前端按钮点击失效一段时间）。<br>为了减少请求HTTP使用了很多手段（TODO：HTTP1.0、1.1、2区别）：</p>
<ul>
<li>HTTP1.1使用了长连接，传输完成后一段时间保持连接不关闭（前端和后端都要配置）</li>
<li>HTTP2可以使用服务器推送<br>目前使用的减少HTTP的主要方式是合并资源文件为一个文件，如CSS、JS、图片等，前端一般会使用Webpack，实际过程很复杂，感觉类似MAVEN。图片可以多张合并，通过CSS偏移响应鼠标点击操作，构造成不同的URL（这个操作好灵性，好像在京东还是什么网站见到过使用）。</li>
</ul>
<h3 id="1-2-使用浏览器缓存"><a href="#1-2-使用浏览器缓存" class="headerlink" title="1.2 使用浏览器缓存"></a>1.2 使用浏览器缓存</h3><p>对于网站而已，CSS、JavaScript、logo图片等静态资源更新的频率都很低，但是每次HTTP请求都要重新请求这些资源，无疑要浪费大量的宽带。可以通过HTTP缓存机制，设定HTTP头中Cache-Control和Expires的属性(TODO:HTTP缓存机制)。<br>如果碰到静态资源文件变化需要及时应用到客户端浏览器，可以通过改变文件名，生成一个新的JS文件并更新HTML文件中的引用。<br>使用浏览器缓存策略更新静态资源时，应采用批量更新的方法（？按照后文推断，应该是避免批量更新），比如需要更新10个图标文件，不宜把10个文件一次全部更新，而是应一个文件一个文件逐步更新，并有一定的间隔时间，以免用户浏览器突然大量缓存失效，集中更新缓存，造成服务器负载骤增、网络堵塞的情况。就是避免缓存雪崩情况出现，包括App的更新推送等实际过程中都是分批推送更新通知的，集中一起更新会打满CDN（这里以前出过比较大的问题）。</p>
<h3 id="1-3-启用压缩"><a href="#1-3-启用压缩" class="headerlink" title="1.3 启用压缩"></a>1.3 启用压缩</h3><p>采用压缩是一种CPU换时间的做法，压缩和解压本身也要消耗一定的时间，要权衡考虑，一般对文本采用压缩，如HTML、CSS、JS文件，压缩过后同时还有利于网络传输。JS代码本身是可以压缩的，这一部分一般通过WebPack管理。使用时要设置HTTP头的Content-Encoding字段。</p>
<h3 id="1-4-CSS放在页面最上面、JavaScript放在页面最下面（先渲染，后加载逻辑）"><a href="#1-4-CSS放在页面最上面、JavaScript放在页面最下面（先渲染，后加载逻辑）" class="headerlink" title="1.4 CSS放在页面最上面、JavaScript放在页面最下面（先渲染，后加载逻辑）"></a>1.4 CSS放在页面最上面、JavaScript放在页面最下面（先渲染，后加载逻辑）</h3><p>浏览器会在下载完全部CSS之后才对整个页面进行渲染，因此最好的做法是将CSS放在页面最上面，让浏览器尽快下载CSS。JavaScript则相反，浏览器在加载JavaScript后立即执行，有可能会阻塞整个页面，造成页面显示缓慢，因此JavaScript最好放在页面最下面。但如果页面解析时就需要用到JavaScript，这时放在底部就不合适了。同时要注意，如果JS还没加载完用户就先操作了，这时可能时无效的。这类做法与抢红包中的抢拆分离类似，目的时造成加载完成的错觉，避免用户的焦急，动画等特效至少可以为后端和链路上的消耗争取几百毫秒时间。</p>
<h3 id="1-5-减少Cookie传输"><a href="#1-5-减少Cookie传输" class="headerlink" title="1.5 减少Cookie传输"></a>1.5 减少Cookie传输</h3><p>每次请求与回应都会完全传输整个Cookie，Cookie太大会影响传输效率，写入Cookie的数据要慎重考虑，也可以把部分数据存储在后端的Session中，这时后端要维护这个Session。对于静态资源的请求使用同一域名也会发送Cookie，静态资源可以使用独立域名，避免发送Cookie。</p>
<h2 id="2-CDN加速"><a href="#2-CDN加速" class="headerlink" title="2. CDN加速"></a>2. CDN加速</h2><p>CDN（Content Distribute Network，内容分发网络）的本质仍然是一个缓存，而且将数据缓存在离用户最近的地方，CDN一般缓存更新频率不高的静态资源，CDN工作流程各个代理商解释的都很详细，推荐阅读<a href="https://cloud.tencent.com/document/product/228/2939" target="_blank" rel="external">腾讯CDN产品概述</a>和<a href="https://www.alibabacloud.com/help/zh/doc-detail/27101.htm" target="_blank" rel="external">什么是阿里云CDN</a>。在CDN过程中DNS起着很大的作用，DNS有着负载均衡的作用，怪不得面试总要考HTTP请求流程，往详细说很复杂（TODO：如何选出最近的服务器，设计接入系统）。</p>
<h2 id="3-反向代理"><a href="#3-反向代理" class="headerlink" title="3. 反向代理"></a>3. 反向代理</h2><p>CDN位于用户接入点附近，而反向代理则位于网站机房的最外侧，代理接收到的HTTP请求，同时也可以实现负载均衡的作用，根据负载均衡算法分发请求。<br>反向代理的优点：</p>
<ul>
<li>实现负载均衡：构建应用集群，提高系统总体处理能力</li>
<li>安全：来自互联网的请求必须经过代理服务器，在Web服务器和可能的网络攻击之间建立屏障</li>
<li>加速Web请求：静态内容缓存在反向代理服务器，减轻Web服务器负载压力。静态内容和动态内容都可以，动态内容要通过通知机制更新<br>反向代理的缺点：</li>
<li>处于OSI参考模型的应用层，每一种协议都需要单独开发反向代理服务器，限制了使用的范围。目前一般用于Web服务器</li>
<li>每次代理，代理服务器就必须打开两个连接，分别针对对内、对外，并发量大时代理服务器可能成为性能瓶颈。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>《大型网站技术架构:核心原理与案例分析》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2018/09/02/缓存使用系列/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/缓存使用系列/" itemprop="url">缓存使用系列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T10:23:25+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/09/02/缓存使用系列/" class="leancloud_visitors" data-flag-title="缓存使用系列">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实际工作中经常用到Redis作为缓存，只要用到缓存，就会碰到缓存穿透、缓存雪崩和缓存击穿。在看了很多博文之后记录一下关于缓存的问题，每个博文有各自的观点，这里做一下总结和个人的理解。  </p>
<h2 id="1-缓存穿透"><a href="#1-缓存穿透" class="headerlink" title="1. 缓存穿透"></a>1. 缓存穿透</h2><p>在大多数互联网应中，缓存是不可或缺的组件，缓存的使用方式如下：</p>
<ol>
<li>当业务系统发起某一个查询请求时，首先判断缓存中是否有该数据；<br>1.1 如果缓存中存在，则直接返回数据</li>
<li>缓存层不命中，查询数据库</li>
<li>然后返回数据，若无返回空结果，有则将结果写入缓存层同时返回结果（存储层和缓存层应有同步措施，保证缓存了最新的数据）<img src="/2018/09/02/缓存使用系列/缓存穿透.png" alt="缓存穿透.png" title="">
</li>
</ol>
<h3 id="1-1-什么是缓存穿透"><a href="#1-1-什么是缓存穿透" class="headerlink" title="1.1 什么是缓存穿透"></a>1.1 什么是缓存穿透</h3><p>在实际的项目中，我们查询数据通常先从缓存中读取，如果缓存存在直接返回。不存在就查询数据库，然后返回结果。如果查询的数据一直不存在，就会一直查询DB，这样缓存就没有作用，当流量很大的时候，DB有可能挂掉。<br>简单而言就是：请求了大量根本不存在的数据，导致所有的请求直接请求到后端DB上，造成DB异常。  </p>
<h3 id="1-2-为什么会发生缓存穿透"><a href="#1-2-为什么会发生缓存穿透" class="headerlink" title="1.2 为什么会发生缓存穿透"></a>1.2 为什么会发生缓存穿透</h3><p>发生缓存穿透的原因很多，一般为两种：</p>
<ol>
<li>恶意攻击和爬虫造成大量空命中</li>
<li>业务自身代码或者数据出现问题</li>
</ol>
<h3 id="1-3-如何发现"><a href="#1-3-如何发现" class="headerlink" title="1.3 如何发现"></a>1.3 如何发现</h3><p>通常使用日志、打点等，记录调用总量、缓存命中数、存储命中数，如果短时间内空命中非常多，可能存在缓存穿透。</p>
<h3 id="1-4-缓存穿透解决方法"><a href="#1-4-缓存穿透解决方法" class="headerlink" title="1.4 缓存穿透解决方法"></a>1.4 缓存穿透解决方法</h3><h4 id="1-4-1-缓存空对象"><a href="#1-4-1-缓存空对象" class="headerlink" title="1.4.1 缓存空对象"></a>1.4.1 缓存空对象</h4><p>在第3步中储存层不命中后，将空对象保存到缓存层中（使用特定key来表示），之后的访问将从缓存层中去查询获取到，从而保护了存储层。<br>这么做也会带来两个问题：</p>
<ol>
<li>对空值缓存意味着需要额外的空间来存放键值，如果是恶意攻击会导致严重的内存占用。有效的措施是对这类数据设置一个较短的过期时间，让其自动剔除（redis对于过期的key采用定时加惰性删除的机制，定时删除不保证一定会清除过期key，除非主动访问）。</li>
<li>缓存层和存储层如果没有同步措施会存在一段时间的窗口不一致，如果设置了过期时间为5分钟，这时存储层添加或者修改了这个数据，此时缓存层和数据层消息就不一致了。我们可以利用消息系统或者其他方式清除掉缓存层中的空对象。</li>
</ol>
<h4 id="1-4-2-布隆过滤器拦截"><a href="#1-4-2-布隆过滤器拦截" class="headerlink" title="1.4.2 布隆过滤器拦截"></a>1.4.2 布隆过滤器拦截</h4><p>一种可行的方案是使用布隆过滤器，将所有存在的key使用布隆过滤器提前保存起来。业务系统首先去查询布隆过滤器中是否存在该key，如果不存在直接返回，因为数据库中也不存在该数据，缓存中也不会存在。<br><img src="/2018/09/02/缓存使用系列/布隆过滤器.png" alt="布隆过滤器.png" title=""></p>
<p>其中5.向bitmap添加数据和缓存非空数据取决于业务的需求，我们一般会定时或者批量更新，而不是每次都触发更新。使用布隆过滤器并不适合强时效和高一致性的场景，布隆过滤器无法处理删除数据，重新生成bitmap将耗费一定时间，而且使用前要预热bitmap。</p>
<h4 id="1-4-3-两种方式的对比"><a href="#1-4-3-两种方式的对比" class="headerlink" title="1.4.3 两种方式的对比"></a>1.4.3 两种方式的对比</h4><table>
<thead>
<tr>
<th>解决方式</th>
<th>适用场景</th>
<th>维护成本</th>
</tr>
</thead>
<tbody>
<tr>
<td>缓存空对象</td>
<td>1.数据命中不高<br>  2.数据频繁变化实时性高</td>
<td>1.代码维护简单<br>  2.需要过多的缓存空间<br>  3.可能存在数据不一致</td>
</tr>
<tr>
<td>布隆过滤器</td>
<td>1.数据命中不高<br>  2.数据相对固定实时性低</td>
<td>1.代码维护复杂<br> 2.缓存占用空间少</td>
</tr>
</tbody>
</table>
<h2 id="2-缓存雪崩"><a href="#2-缓存雪崩" class="headerlink" title="2. 缓存雪崩"></a>2. 缓存雪崩</h2><h3 id="2-1-什么是缓存雪崩"><a href="#2-1-什么是缓存雪崩" class="headerlink" title="2.1 什么是缓存雪崩"></a>2.1 什么是缓存雪崩</h3><p>在实际应用中，通过合理的设置缓存，大部分请求都通过缓存层返回，有效的保护了存储层，但是由于缓存层出现问题（比如宕机或者缓存超时集体失效），所有或者超出存储层极限的调用都会直接到达存储层，从而导致存储层也挂掉。</p>
<h3 id="2-2-如何预防缓存雪崩"><a href="#2-2-如何预防缓存雪崩" class="headerlink" title="2.2 如何预防缓存雪崩"></a>2.2 如何预防缓存雪崩</h3><h4 id="2-2-1-保证缓存层服务高可用"><a href="#2-2-1-保证缓存层服务高可用" class="headerlink" title="2.2.1 保证缓存层服务高可用"></a>2.2.1 保证缓存层服务高可用</h4><p>面对这种情况我们一般引入集群，通过负载均衡算法分解请求，Redis Sentinel和Redis Cluster暂时还没有用过，TODO:负载均衡算法和Redis集群部分改日填坑。</p>
<h4 id="2-2-2-依赖隔离组件为后端限流并降级"><a href="#2-2-2-依赖隔离组件为后端限流并降级" class="headerlink" title="2.2.2 依赖隔离组件为后端限流并降级"></a>2.2.2 依赖隔离组件为后端限流并降级</h4><p>基础组件不是永远可靠的，在实际过程中经常碰到基础服务出现问题，小则过载，大则宕机，一些过载恢复机制会随机将请求发送到过载节点，通过返回结果来判断过载服务是否恢复，至于是谁来做重试要看业务的需求。<br>降级在高并发系统中是常见的：比如个性推荐服务中，如果个性化需求不能提供服务了，可以降级补充热点数据，不至于造成前端页面空白。<br>至于hystrix我目前并没有用过，现在组件都是微服务了，基础服务和业务都有自己线程池管理方式，改日再看情况填坑。</p>
<h2 id="3-缓存击穿（热点key失效）"><a href="#3-缓存击穿（热点key失效）" class="headerlink" title="3. 缓存击穿（热点key失效）"></a>3. 缓存击穿（热点key失效）</h2><p>这里我看了几篇博文，发现缓存击穿和热点key失效说的是一回事。缓存雪崩和缓存击穿的区别是，缓存雪崩针对的是大量key，击穿针对很少的几热点个key产生大量请求，可以看作是雪崩中的的特例，但请求量会非常大。</p>
<h3 id="3-1-缓存击穿的危害"><a href="#3-1-缓存击穿的危害" class="headerlink" title="3.1 缓存击穿的危害"></a>3.1 缓存击穿的危害</h3><p>当以下两个问题同时出现，可能会对系统造成致命的危害：</p>
<ol>
<li>这个key是热点key（例如重要的新闻等），短时间内的访问量可能非常大。</li>
<li>缓存的构建需要一定时间，比如要经过复杂运算、多次IO、数据库访问、依赖其它接口等等（比如游戏的赛季排行榜）。</li>
</ol>
<p>于是就会碰到致命问题，缓存失效的瞬间有大量的线程来构建缓存（如下图，直接盗图），造成后端负载加大，甚至系统崩溃。<br><img src="/2018/09/02/缓存使用系列/缓存击穿.png" alt="缓存击穿.png" title=""></p>
<h3 id="3-2-缓存击穿的解决方案"><a href="#3-2-缓存击穿的解决方案" class="headerlink" title="3.2 缓存击穿的解决方案"></a>3.2 缓存击穿的解决方案</h3><p>我们尽量使用较少的线程来构建缓存（甚至是一个）</p>
<h4 id="3-2-1-使用互斥锁"><a href="#3-2-1-使用互斥锁" class="headerlink" title="3.2.1 使用互斥锁"></a>3.2.1 使用互斥锁</h4><p>互斥锁的解决思路比较简单，就是同一时间只让一个线程来构建线程，其他线程等待缓存构建完，再从缓存中获取数据就可以。</p>
<p>互斥锁分单机和分布式环境。单机环境使用编程语言提供的锁来处理便可，分布式环境使用分布式锁就可以，Redis和zookeeper都可以实现分布式锁，如何实现改日再填坑（TODO：分布式锁）<br>原文都给了互斥锁的实现，但是这个锁是有问题的，而且是有发生死锁的可能性，想一想为什么？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">   String value = redis.get(key);</div><div class="line">   <span class="keyword">if</span> (value  == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (redis.setnx(key_mutex, <span class="string">"1"</span>)) &#123;</div><div class="line">        <span class="comment">// 设定一个时间，防止db.get()方法产生死锁，要保证这个时间大于db.get()的执行时间</span></div><div class="line">        redis.expire(key_mutex, <span class="number">3</span> * <span class="number">60</span>)</div><div class="line">        value = db.get(key);</div><div class="line">        redis.set(key, value);</div><div class="line">        redis.delete(key_mutex);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//其他线程休息50毫秒后重试</span></div><div class="line">        Thread.sleep(<span class="number">50</span>);</div><div class="line">        get(key);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>原因：<strong>Redis事务和传统数据库事务定义不同</strong>，setnx和expire这两个操作并不能保证原子性，如果setnx成功之后代码没有执行就会一直锁住，原博主没有详细解释产生死锁的原因。</p>
<h4 id="3-2-2-永不过期"><a href="#3-2-2-永不过期" class="headerlink" title="3.2.2 永不过期"></a>3.2.2 永不过期</h4><ol>
<li>Reis上不再设计过期时间，保证“物理”不过期</li>
<li>过期时间放在key对应的value里，如果过期了，先返回旧值，后台通过异步线程构建缓存，然后更新，也就是“逻辑”上过期（Java的CopyOnWrite非常与之类似，TODO：CopyOnWrite容器源码分析）</li>
</ol>
<p>这种方式对于性能非常友好，几乎不会造成请求的阻塞，但是不适用强一致性的数据读取，因为其余线程可能读到的是老的数据。</p>
<h4 id="3-2-3-两种方式的对比"><a href="#3-2-3-两种方式的对比" class="headerlink" title="3.2.3 两种方式的对比"></a>3.2.3 两种方式的对比</h4><table>
<thead>
<tr>
<th>解决方案</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>互斥锁</td>
<td>1.思路简单<br>  2.保证强一致性</td>
<td>1.代码复杂度增大<br>  2.存在死锁的风险<br>  3.存在线程池阻塞的风险</td>
</tr>
<tr>
<td>永不过期</td>
<td>1.异步构建，不会阻塞线程池<br></td>
<td>1.不保证一致性<br> 2.代码复杂度增大(每个value都要维护一个timekey)<br> 3.占用一定的内存空间(每个value都要维护一个timekey)。</td>
</tr>
</tbody>
</table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://mp.weixin.qq.com/s/TBCEwLVAXdsTszRVpXhVug" target="_blank" rel="external">Redis架构之防雪崩设计：网站不宕机背后的兵法</a></li>
<li><a href="http://blog.didispace.com/chengchao-huancun-zuijiazhaoshi" target="_blank" rel="external">缓存穿透、缓存并发、热点缓存之最佳招式</a></li>
<li>《Redis开发与运维》</li>
<li><a href="http://carlosfu.iteye.com/blog/2248185" target="_blank" rel="external">缓存系列文章–5.缓存穿透问题</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2018/08/23/Maven学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/Maven学习笔记/" itemprop="url">Maven学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T01:17:35+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/08/23/Maven学习笔记/" class="leancloud_visitors" data-flag-title="Maven学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Maven学习笔记"><a href="#Maven学习笔记" class="headerlink" title="Maven学习笔记"></a>Maven学习笔记</h1><h2 id="1-是什么"><a href="#1-是什么" class="headerlink" title="1. 是什么"></a>1. 是什么</h2><p>基于Java的跨平台项目管理及自动构建工具</p>
<h2 id="2-入门"><a href="#2-入门" class="headerlink" title="2. 入门"></a>2. 入门</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt; <span class="comment">&lt;!--xml版本和编码方式 --&gt;</span></div><div class="line"><span class="comment">&lt;!--project是pom.xml的根元素--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--modelVersion指定了POM模型的版本，Maven2和3只能为4.0.0--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--groupId定义项目属于哪个组，同项目所在的组织或者公司存在关联--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--当前项目在组中唯一的ID--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--项目当前的版本号--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>以上是Maven项目的基本配置文件，其余的各项配置写在<code>&lt;project&gt;&lt;/project&gt;</code>标签内</p>
<h2 id="3-坐标和依赖"><a href="#3-坐标和依赖" class="headerlink" title="3. 坐标和依赖"></a>3. 坐标和依赖</h2><h3 id="3-1-入门"><a href="#3-1-入门" class="headerlink" title="3.1 入门"></a>3.1 入门</h3><p>我们先看一组坐标定义<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonatype.nexus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nexus-indexer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>groupId：定义当前Maven项目隶属的实际目录，groupId不应该对应项目隶属的额组织或者公司，由于组织下会有许多实际项目，groupId只定义到组织级别，artifactId只能定义Maven项目（模块），实际项目将难以定义。</li>
<li>artifactId：定义实际项目中的一个Maven项目（模块），推荐使用实际项目名称作为artifactId的前缀</li>
<li>version：定义Maven项目所处的版本</li>
<li>packaging：定义Maven项目的打包方式，打包方式通常与所生成构件的文件扩展名对应，<strong>打包方式会影响到构建的生命周期</strong>，不定义packaging的时候，Maven会使用默认至jar。</li>
<li>classifier：定义构建输出的一些附属构建，附属构建与主构建对应。如上例中主构建是nexus-indexer-2.0.0jar，该项目可能还会通过使用一些插件生成如nexus-indexer-2.0.0-javadoc.jar、nexus-indexer-2.0.0-sources.jar这样一些附属构建，其中包含了Java文档和源代码。javadoc和sources就是这两个附属构建的classifier。<strong>不能直接定义项目的classifier，因为附属构件不是项目直接默认生成的，而是有附件的插件帮助生产</strong><br>上述5个元素中，groupId、artifactId、version是必须定义的，packaging是可选的（默认为jar），而classifier是不能直接定义的。<br>项目构件的文件名是与坐标相对应的额，<strong>一般的规则为artifactId-version[-classifier].packaging</strong>。</li>
</ul>
<h3 id="3-2-详解"><a href="#3-2-详解" class="headerlink" title="3.2 详解"></a>3.2 详解</h3><p>一个依赖可以包含如下的一些元素：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">...</div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>...<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>...<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>...<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>...<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>...<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>...<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                ...</div><div class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li>type：依赖的类型，对应于项目坐标定义的packaging。大部分情况下，该元素不必声明，默认为jar。</li>
<li>scope：依赖范围，见<a href="#scope">3.2.1</a></li>
<li>optional：依赖是否可选</li>
<li>exclusions：排除依赖传递性</li>
</ul>
<h4 id="3-2-1-scope详解"><a href="#3-2-1-scope详解" class="headerlink" title="3.2.1 scope详解"></a><span id="scope">3.2.1 scope详解</span></h4><p>scope有以下几种以来范围：</p>
<ul>
<li>compile：编译依赖范围。如果没有指定默认使用该依赖范围。此种依赖范围对于编译、测试、运行三种classpath都有效，如spring-core。</li>
<li>test：测试依赖范围。对测试classpath有效，在编译主代码或者运行项目时无法使用此依赖，如Junit。</li>
<li>provided：已提供依赖范围。对编译和测试classpath有效，但在运行时无效。如servlet-api，编译和测试时需要，运行时由容器提供，不需要重复引用。</li>
<li>runtime：运行时依赖范围。对测试和运行有效,编译时无效。如JDBC驱动实现,项目代码只需要JDK提供的JDBC接口，只有在执行测试或者运行项目的时候才需要实现上述接口的具体JDBC驱动。</li>
<li><p>system：系统依赖范围。同provided，对编译和测试classpath有效，但在运行时无效，但是必须通过systempath元素显示指定依赖文件的路径。<strong>不可移植</strong>，可引用环境变量。如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.sql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdbc-stdext<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;java.hone&#125;/lib/rt.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>import：导入依赖范围，只在dependencyManagement元素下有效，见<a href="#import">6.2.2</a></p>
</li>
</ul>
<h3 id="3-3-传递性依赖"><a href="#3-3-传递性依赖" class="headerlink" title="3.3 传递性依赖"></a>3.3 传递性依赖</h3><h4 id="3-3-1-什么是传递性依赖"><a href="#3-3-1-什么是传递性依赖" class="headerlink" title="3.3.1 什么是传递性依赖"></a>3.3.1 什么是传递性依赖</h4><p>Mavan会解析各个直接依赖的POM，将必要的间接以来，以传递性以来的形式引入到当前的项目中。如项目依赖spring-core，sprng-core又依赖commons-logging，那commons-logging就会成为当前项目的依赖范围。</p>
<h4 id="3-3-2-传递性依赖和依赖范围"><a href="#3-3-2-传递性依赖和依赖范围" class="headerlink" title="3.3.2 传递性依赖和依赖范围"></a>3.3.2 传递性依赖和依赖范围</h4><p>依赖范围不仅控制依赖与三种classpath的关系，还会对传递性依赖产生影响。最左边一列表示直接依赖范围，第一行表示第二直接依赖范围。  </p>
<table>
<thead>
<tr>
<th></th>
<th>compile</th>
<th>test</th>
<th>provided</th>
<th>runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td>compile</td>
<td>compile</td>
<td>-</td>
<td>-</td>
<td>runtime</td>
</tr>
<tr>
<td>test</td>
<td>test</td>
<td>-</td>
<td>-</td>
<td>test</td>
</tr>
<tr>
<td>provided</td>
<td>provided</td>
<td>-</td>
<td>provided</td>
<td>provided</td>
</tr>
<tr>
<td>runtime</td>
<td>runtime</td>
<td>-</td>
<td>-</td>
<td>runtime</td>
</tr>
</tbody>
</table>
<h3 id="3-4-依赖调解"><a href="#3-4-依赖调解" class="headerlink" title="3.4 依赖调解"></a>3.4 依赖调解</h3><p>当项目的依赖关系中对同一依赖有不同版本的描述，就会发生依赖调节，遵循一下两条原则  </p>
<ul>
<li><strong>路径最近者有限</strong>：如A-&gt;X(1.0)-&gt;C,A-&gt;B-&gt;c-&gt;X(2.0),X(1.0)长度为2,X(2.0)长度为4,Maven会选择最近的X(1.0)</li>
<li><strong>第一声明者优先</strong>：当依赖路径长度相等的前提下，在POM中依赖声明中顺序最考前的依赖会被解析使用</li>
</ul>
<h3 id="3-5-可选依赖"><a href="#3-5-可选依赖" class="headerlink" title="3.5 可选依赖"></a>3.5 可选依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- declare the dependency to be set as optional --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>sample.ProjectA<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span> <span class="comment">&lt;!-- value will be true or false only --&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
<p>该项目中将Project-A声明为可选依赖，如果其他项目依赖该项目并要使用Project-A，就需要显示的声明Project-A的依赖。理想情况下我们不应该使用可选依赖，而是分别创建一个Maven项目。</p>
<h3 id="3-6-实战"><a href="#3-6-实战" class="headerlink" title="3.6 实战"></a>3.6 实战</h3><h4 id="3-6-1-排除依赖"><a href="#3-6-1-排除依赖" class="headerlink" title="3.6.1 排除依赖"></a>3.6.1 排除依赖</h4><p>当项目中的某个类库不稳定会影响到当前项目或者要替换某个传递性依赖时就需要排除依赖。具体是在<code>&lt;dependency&gt;&lt;/dependency&gt;</code>中增加<code>&lt;ecxlusions&gt;&lt;/ecxlusions&gt;</code>标签。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>sample.ProjectA<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>  <span class="comment">&lt;!-- declare the exclusion here --&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>sample.ProjectB<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Project-B<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们将Project-B排除，注意不需要version，因为groupId和artifactId能唯一确定依赖图中的某个依赖，在以后的Maven解析中，不可能出现groupId和artifactId相同，但是version不同的两个依赖。</p>
<h4 id="3-6-2-归类依赖"><a href="#3-6-2-归类依赖" class="headerlink" title="3.6.2 归类依赖"></a>3.6.2 归类依赖</h4><p>通过使用Maven属性在<code>&lt;version&gt;&lt;/version&gt;</code>标签中使用<code>${springframework.version}</code>来归类依赖</p>
<h4 id="3-6-3-优化依赖"><a href="#3-6-3-优化依赖" class="headerlink" title="3.6.3 优化依赖"></a>3.6.3 优化依赖</h4><p>Maven会自定解析项目的直接依赖和传递性以来，依据股则判断依赖范围，对依赖冲突进行调节确保任何一个构件只有唯一的版本在依赖中存在，最后得到的那些依赖被称为已解析依赖（Resolved Dependency）。</p>
<ul>
<li><code>mvn dependency:list</code>：查看当前项目的已解析依赖</li>
<li><code>mvn dependency:tree</code>：查看当前项目的依赖树</li>
<li><code>mvn dependency:analyze</code>：分析当前项目的依赖</li>
</ul>
<h2 id="4-仓库"><a href="#4-仓库" class="headerlink" title="4. 仓库"></a>4. 仓库</h2><h3 id="4-1-介绍"><a href="#4-1-介绍" class="headerlink" title="4.1 介绍"></a>4.1 介绍</h3><p>Maven在某个位置统一存储所有Maven项目共享的构建，实际的Maven项目将不再各自存储其依赖的文件。</p>
<h3 id="4-2-仓库的布局"><a href="#4-2-仓库的布局" class="headerlink" title="4.2 仓库的布局"></a>4.2 仓库的布局</h3><p>Maven构件的存储路径为：groupId/artifactId/version/artifactId-version[-classifier].packaging。句点分割会被转化成路径分割，如log4j:log4j:1.2.15对应的仓库路径为log4j/log4j/1.2.15/log4j-1.2.15.jar。</p>
<h3 id="4-3-仓库分类"><a href="#4-3-仓库分类" class="headerlink" title="4.3 仓库分类"></a>4.3 仓库分类</h3>
<p>仓库分为两类：本地仓库和远程仓库，优先查找本地仓库是否有构件。远程仓库有两类特殊仓库：中央仓库和私服。</p>
<ul>
<li>中央仓库：Maven核心自带的远程仓库，包含了绝大部分开源构建。默认本地没有Maven需要的构建时会从中央仓库下载。</li>
<li>私服：在局域网内架设的私有仓库服务器，用来代理所有外部的远程仓库，内部项目可以部署到私服上供其他项目使用。</li>
</ul>
<h4 id="4-3-1-本地仓库"><a href="#4-3-1-本地仓库" class="headerlink" title="4.3.1 本地仓库"></a>4.3.1 本地仓库</h4><p>默认情况下,有一个路径名为~/.m2/repository/的仓库，如果用户想要自定义仓库的位置，可以编辑该文件。如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\java\repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>默认情况下该文件不存在，用户需要从$M2_HOME/conf/settings.xml复制再编辑，不推荐直接修改全局目录的settings.xml文件，因为每次升级该文件都会被覆盖。</p>
<h4 id="4-3-2-中央仓库"><a href="#4-3-2-中央仓库" class="headerlink" title="4.3.2 中央仓库"></a>4.3.2 中央仓库</h4><p>由于必须有至少一个可用的远程仓库才能在执行Maven命令时下载到需要的构件，可以解压Maven的jar文件，然后访问路径org/apache/maven/model/pom-4.0.0.xml查看pom中央仓库配置。所有的Maven都会继承该超级POM。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Central Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="4-3-3-私服"><a href="#4-3-3-私服" class="headerlink" title="4.3.3 私服"></a>4.3.3 私服</h4><p>一种特殊的远程仓库，架设在局域网内。当Maven需要下载构件的时候，先向私服请求，如果私服上不存在，则会从外部的远程仓库下载，缓存在私服上。无法从外部仓库下载到的构件也能从本地上传到私服供大家使用。<br><img src="/2018/08/23/Maven学习笔记/私服的用途.png" alt="私服的用途.png" title=""></p>
<table>
<thead>
<tr>
<th>节省外网带宽</th>
<th>消除对外重复构件的下载</th>
</tr>
</thead>
<tbody>
<tr>
<td>加速Maven构建</td>
<td>Maven的一些内部机制（如快照更新检查）会在执行构建的时候不停地检查远程仓库数据，当配置了很多外部仓库的时候，构建的速度会被大大降低。使用私服时只需要检查局域网内私服的数据</td>
</tr>
<tr>
<td>部署第三方构件</td>
<td>私有构件无法从外部仓库获得，部署到内部仓库，供内部的Maven项目使用</td>
</tr>
<tr>
<td>提高稳定性，增强控制</td>
<td>防止Internet不稳定的时候，Maven构建变得不稳定。一些私服软件（如Nexus）还提供了许多额外的功能，如权限管理、RELEASE/SNAPSHOT区分等，管理员可以对仓库进行一些更高级的控制</td>
</tr>
<tr>
<td>降低中央仓库的负荷</td>
<td>避免对中央仓库重复的下载</td>
</tr>
</tbody>
</table>
<h3 id="4-4-远程仓库的配置"><a href="#4-4-远程仓库的配置" class="headerlink" title="4.4 远程仓库的配置"></a>4.4 远程仓库的配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 使用repository申明一个或者多个远程仓库 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 仓库唯一标识，重复会覆盖上一个远程仓库 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>...<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 仓库名称 --&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>...<span class="tag">&lt;/<span class="name">name</span>&gt;</span> </div><div class="line">        <span class="comment">&lt;!-- 仓库地址，一般来说该地址都是基于http协议 --&gt;</span>   </div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>...<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 重要！控制Maven对于发布版本构件的下载 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- true/false 控制发布版本构件的下载 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>...<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 更新策略 daily(默认，每天一次)、never(从不)、always（每次构建）、interval:X（间隔X分钟） --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>...<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>  </div><div class="line">            <span class="comment">&lt;!-- 检查检验和文件的策略 warn(默认，校验失败，输出警告信息)、fail（遇到校验和错误就要构建失败）、ignore(忽略校验失败) --&gt;</span>  </div><div class="line">            <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>...<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span>    </div><div class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="comment">&lt;!-- 重要！控制Maven对于快照版本构件的下载 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- true/false 控制快照版本构件的下载 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>...<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span>    </div><div class="line">             <span class="comment">&lt;!-- 更新策略 daily(默认，每天一次)、never(从不)、always（每次构建）、interval:X（间隔X分钟） --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>...<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>   </div><div class="line">            <span class="comment">&lt;!-- 检查检验和文件的策略 warn(默认，校验失败，输出警告信息)、fail（遇到校验和错误就要构建失败）、ignore(忽略校验失败) --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>...<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 仓库布局方式 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="4-4-1-远程仓库的认证"><a href="#4-4-1-远程仓库的认证" class="headerlink" title="4.4.1 远程仓库的认证"></a>4.4.1 远程仓库的认证</h4><p>大部分远程仓库无需认证就可以访问，但有些时候出于安全方面的考虑，需要提供认证信息才能访问一些远程仓库，如私服等。<br><strong>认证信息必须配置在settings.xml文件中，POM往往被提交到代码仓库中供所有成员访问，为了保证安全写在本机的settings.xml文件</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">    ...</div><div class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>..<span class="tag">&lt;/<span class="name">id</span>&gt;</span><span class="comment">&lt;!-- 需要提供认证信息才能访问的远程仓库ID，与repository元素的id完全一致 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span>...<span class="tag">&lt;/<span class="name">username</span>&gt;</span>    <span class="comment">&lt;!-- 用户名 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>...<span class="tag">&lt;/<span class="name">password</span>&gt;</span>    <span class="comment">&lt;!-- 密码 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="4-4-2-部署至远程仓库"><a href="#4-4-2-部署至远程仓库" class="headerlink" title="4.4.2 部署至远程仓库"></a>4.4.2 部署至远程仓库</h4><p>私服的一个作用是部署第三方构件，Maven除了能对项目进行编译、测试、打包之外，还能将项目生成的构建部署到仓库中。  </p>
<ul>
<li><p>1.首先编辑pom文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 写在distributionManagement元素中 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>    <span class="comment">&lt;!-- 指定发布版本构件的仓库 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>...<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>...<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    <span class="comment">&lt;!-- name是方便人阅读 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>...<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span>    <span class="comment">&lt;!-- 指定快照版本构件的仓库 --&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">id</span>&gt;</span>...<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>...<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>...<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">distyibutionManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>2.往远程仓库部署构件时往往需要认真，要配置认证信息</p>
</li>
<li>3.执行 <code>mvn clean deploy</code>，部署到远程仓库</li>
</ul>
<h3 id="4-5-快照版本"><a href="#4-5-快照版本" class="headerlink" title="4.5 快照版本"></a>4.5 快照版本</h3><p>Maven中任何一个项目或者构件都必须有自己的版本，本分分为<strong>发布版</strong>和<strong>快照版</strong>。<br>发布版：稳定，版本值可能是1.0.0、1.3alpha-4、2.0<br>快照版：不稳定，版本值2.1-SNAPSHOT、2.1-20091214.221414-13<br>只需将版本号后加-SNAPSHOT，然后发布到私服中，Maven就会自动为构件打上时间戳，如2.1-20091214.221414-13 表示2009年12月14日22时14分14秒第13次快照。<br>默认情况下，Maven每天检查一次更新（由仓库配置的updatePolicy控制），用户也可以强制让Maven检查更新，如<code>mvn clean install -U</code></p>
<h3 id="4-6-从仓库解析依赖的机制"><a href="#4-6-从仓库解析依赖的机制" class="headerlink" title="4.6 从仓库解析依赖的机制"></a>4.6 从仓库解析依赖的机制</h3><p>当本地仓库没有依赖构件时，Maven会自动从远程仓库下载；当依赖版本为快照版本时，Maven会自动找到最新的快照。其依赖解析机制如下</p>
<ul>
<li>1）依赖范围是system，Maven直接从本地文件系统解析构件。</li>
<li>2）根据依赖坐标计算仓库路径，尝试直接直接从本地仓库寻找构件，如果发现相应构件，则解析成功。</li>
<li>3）本地仓库不存在相应构件的情况下，如果依赖的版本是显式的发布版本构件（如1.0,2.1-beta-1），遍历所有远程仓库，发现后下载并解析使用</li>
<li>4）如果依赖版本是RELEASE和LATEST,则基于更新策略读取所有远程仓库的元数据groupId/artifactId/maven-metadata.xml,将其与本地仓库的对应元数据合并后，计算出RELEASE或LATEST的真实的值，然后基于这个值检查本地和远程仓库,如步骤2）和3）。</li>
<li>5）如果依赖版本是SNAPSHOT，则基于更新策略读取所有远程仓库的元数据groupId/artifactId/version/maven-metadata.xml，将其与本地仓库的对应元数据合并后，得到最新快照版本的值，然后基于该值检查本地仓库和远程仓库。</li>
<li>6）如果最后解析得到的构件版本是时间戳格式的快照，如1.4.1-20091104.121450-121，则复制其时间戳格式文件至非时间戳格式，如SNAPSHOT,并使用该非时间戳格式的构件。<br>当依赖的版本不明晰的时候，如<strong>RELEASE</strong>、<strong>LATEST</strong>和<strong>SNAPSHOT</strong>，Maven需要基于更新远程仓库的更新策略来检查更新。与<code>&lt;release&gt;</code>和<code>&lt;snapshots&gt;</code>中的子元素<code>&lt;enable&gt;</code>和<code>&lt;updatePolicy&gt;</code>有关，只有enable为true才能访问该仓库对应发布版本的构件信息。依赖声明中不推荐使用LATEST和RELEASE，因为Maven随时可能解析到不同的构件，且Maven不会明确告诉用户这样的变化。<br><strong>Maven3不再支持在插件配置中使用LATEST和RELEASE，如果不设置插件版本，其效果和RELEASE一样，Maven只会解析最新的发布版本构件</strong></li>
</ul>
<h3 id="4-7-镜像"><a href="#4-7-镜像" class="headerlink" title="4.7 镜像"></a>4.7 镜像</h3><p>如果仓库X可以提供仓库Y存储的所有内容，那么就可以认为X是Y的一个镜像。使用镜像的目的是提供比中央仓库更快的服务，修改settings.xml如下。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">...</div><div class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- mirrorOf代表被代理的地址，该值与前面的repository的id值保持一致，central表示代理中央接口--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>&lt;mirrorOf&gt;</code>标签的匹配规则如下:</p>
<ul>
<li>*:匹配所有远程仓库</li>
<li>external：*：匹配所有远程仓库，使用localhost和file：//协议的除外。也就是说，匹配所有不在本机上的远程仓库</li>
<li>repo1,repo2：匹配仓库repo1和repo2，逗号分隔</li>
<li><em>,!repo1：匹配除repo1以外的所有远程仓库，感叹号排除<br><em>*镜像完全屏蔽了仓库镜像，当镜像仓库不稳定或者停止服务的时候，Maven仍将无法访问被镜像的仓库，因而无法下载构件</em></em></li>
</ul>
<h3 id="4-8-仓库搜索服务"><a href="#4-8-仓库搜索服务" class="headerlink" title="4.8 仓库搜索服务"></a>4.8 仓库搜索服务</h3><ul>
<li><a href="https://www.sonatype.com" target="_blank" rel="external">Sonatype Nexus</a></li>
<li><a href="https://mvnrepository.com/" target="_blank" rel="external">MVNrepository</a></li>
</ul>
<h2 id="5-生命周期和插件"><a href="#5-生命周期和插件" class="headerlink" title="5. 生命周期和插件"></a>5. 生命周期和插件</h2><h3 id="5-1-生命周期简介"><a href="#5-1-生命周期简介" class="headerlink" title="5.1 生命周期简介"></a>5.1 生命周期简介</h3><p>Maven从大量项目和构建工具中学习和反思，总结了一套高度完善的、易扩展的生命周期。包含项目的清理、初始化、编译、测试、打包、集成测试、验证、部署和站点生成等。<br>Maven的生命周期是抽象的，实际的任务都交由插件来完成。</p>
<h3 id="5-2-生命周期详解"><a href="#5-2-生命周期详解" class="headerlink" title="5.2 生命周期详解"></a>5.2 生命周期详解</h3><h4 id="5-2-1-三套生命周期"><a href="#5-2-1-三套生命周期" class="headerlink" title="5.2.1 三套生命周期"></a>5.2.1 三套生命周期</h4><p>Maven拥有三套相互独立的生命周期，分别为clean、default和site，调用这三者中的一个不会触发其它两个生命周期。</p>
<ul>
<li>clean：清理项目</li>
<li>default：构建项目</li>
<li>site：建立目标站点</li>
</ul>
<p>每个生命周期包含一些<strong>有序阶段</strong>，并且后面的阶段依赖于前面的阶段。如clean生命周期包含pre-clean、clean和post-clean，调用pre-clean的时候，只有pre-clean阶段执行调用clean的时候pre-clean和clean阶段都会执行。</p>
<h4 id="5-2-2-clean生命周期"><a href="#5-2-2-clean生命周期" class="headerlink" title="5.2.2 clean生命周期"></a>5.2.2 clean生命周期</h4><p>clean生命周期的目的是清理项目，它包含三个阶段：</p>
<ul>
<li>pre-clean：执行一些清理前需要完成的工作</li>
<li>clean：清理上一次构建生成的文件</li>
<li>post-clean：执行一些清理后需要完成的工作</li>
</ul>
<h4 id="5-2-3-default生命周期"><a href="#5-2-3-default生命周期" class="headerlink" title="5.2.3 default生命周期"></a>5.2.3 default生命周期</h4><p>default是所有生命周期中的核心，定义了真正构建时所需要执行的所有步骤</p>
<ul>
<li>validate：验证这个项目是否正确，所有必需资源是否可用</li>
<li>initialize：初始化编译的状态，例如：设置一些properties属性，或者创建一些目录</li>
<li>generate-sources：生成所有在编译阶段需要的源代码</li>
<li>process-sources：处理项目主资源文件。一般来说，是对src/main/resources目录的内容进行变量替换等工作后，复制到项目输出的主classpath目录中。</li>
<li>generate-resources：生成这个项目包所有需要包含的资源文件</li>
<li>process-resources：复制并处理资源文件到目标目录，为packaging 打包阶段做好准备</li>
<li>compile：编译项目的主源码，一般来说，是编译src/main/java目录下的Java文件至项目输出的主classpath目录中</li>
<li>process-classes：后置处理编译阶段生成的文件，例如：做java字节码的加强操作</li>
<li>generate-test-sources：生成编译阶段需要的test源代码</li>
<li>process-test-sources：处理项目测试资源文件。一般来说，是对src/main/resources目录的内容进行变量替换等工作后，复制到项目输出的测试classpath目录中。</li>
<li>generate-test-resources：生成test测试需要的资源文件</li>
<li>process-test-resources：复制并处理资源文件到test测试目标目录</li>
<li>test-compile:编译项目的测试代码到指定test目标目录</li>
<li>process-test-classes:后置处理test编译阶段生成的文件，例如：做java字节码的加强操作</li>
<li>test:使用合适的单元测试框架，运行所有测试例子，这些测试用例不应该要求这些代码被打包或者部署才能执行</li>
<li>prepare-package:处理任何需要在正式打包之前要完成的必须的准备工作。这一步的通常结果是解压，处理包版本等</li>
<li>package：打包编译后的代码成可发包格式，例如：jar,war等</li>
<li>pre-integration-test：完成一些在集成测试之前需要做的预处理操作，这通常包括建立需要的环境。</li>
<li>integration-test：处理并部署（deploy）包到集成测试可以运行的环境中</li>
<li>post-integration-test：处理一些集成测试之后的事情，通常包括一些环境的清理工作</li>
<li>verify：做一些对包的验证操作，去检测这个包是一个合法的符合标准的包。</li>
<li>install：将包安装到本地仓库，供本地其他Maven项目使用</li>
<li>deploy：将最终的包复制到远程仓库，供其他开发人员和Maven项目使用</li>
</ul>
<h4 id="5-2-4-site生命周期"><a href="#5-2-4-site生命周期" class="headerlink" title="5.2.4 site生命周期"></a>5.2.4 site生命周期</h4><p>site生命周期的目的是建立和发布项目站点，Maven能够基于POM所包含的信息，自动生成一个友好的站点，方便团队交流和发布项目信息</p>
<ul>
<li>pre-site：执行一些在生成项目站点之前需要完成的工作</li>
<li>site：生成项目站点文档</li>
<li>post-site：执行一些在生成项目站点之后需要完成的工作</li>
<li>site-deploy：将生成的项目站点发布到服务器上</li>
</ul>
<h4 id="5-2-5-命令行与生命周期"><a href="#5-2-5-命令行与生命周期" class="headerlink" title="5.2.5 命令行与生命周期"></a>5.2.5 命令行与生命周期</h4><p>我们前面说过各个生命周期是相互独立的，但一个生命周期的阶段是有前后依赖关系的</p>
<ul>
<li><code>mvn clean</code>：调用clean生命周期的clean阶段，实际执行clean生命周期的pre-clean和clean阶段</li>
<li><code>mvn test</code>：调用default生命周期的test阶段，实际执行default生命周期的validate、initiaalize等直到test的所有阶段</li>
<li><code>mvn clean install</code>：调用clean生命周期的clean阶段和default生命周期的install阶段，实际执行了clean生命周期的pre-clean、clean阶段以及default生命周期的从validate至install的所有阶段。结合了两个生命周期，非常适用于项目构建之前清理项目</li>
<li><code>mvn clean deploy site-deploy</code>：实际执行clean生命周期的pre-clean 和clean ，default生命周期的所有阶段，以及site生命周期的所有阶段</li>
</ul>
<h3 id="5-3-插件目标与绑定"><a href="#5-3-插件目标与绑定" class="headerlink" title="5.3 插件目标与绑定"></a>5.3 插件目标与绑定</h3><p>Maven核心仅仅定义了抽象的生命周期，实际的任务是交由插件完成，生命周期与插件相互绑定，用以完成实际的构建任务。一个插件有多个功能，每个功能就是一个插件目标。通用写法是插件前缀：插件目标。</p>
<h4 id="5-3-1-自定义绑定"><a href="#5-3-1-自定义绑定" class="headerlink" title="5.3.1 自定义绑定"></a>5.3.1 自定义绑定</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 推荐使用非快照版本 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 配置一个任务 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 任务id --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-sources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 绑定的生命周期 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- 配置插件目标 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="5-4-插件配置"><a href="#5-4-插件配置" class="headerlink" title="5.4 插件配置"></a>5.4 插件配置</h3><h4 id="5-4-1-命令行插件配置"><a href="#5-4-1-命令行插件配置" class="headerlink" title="5.4.1 命令行插件配置"></a>5.4.1 命令行插件配置</h4><p><strong>Maven命令中使用-D参数，并伴随一个参数键=参数值的形式</strong><br>例如：install–Dmaven.test.skip=true，跳过测试</p>
<h4 id="5-4-2-POM中插件全局配置"><a href="#5-4-2-POM中插件全局配置" class="headerlink" title="5.4.2 POM中插件全局配置"></a>5.4.2 POM中插件全局配置</h4><p>我们可以在声明插件的时候，对此插件进行一个全局的配置让所有基于该插件的目标任务都使用这些配置。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- 对插件进行全局设置，不管此插件绑定到什么阶段都使用同样的配置 --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- 编译1.7版本的源文件 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!-- 生成与JVM 1.7 兼容的字节码文件 --&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="5-4-3-POM中插件任务配置"><a href="#5-4-3-POM中插件任务配置" class="headerlink" title="5.4.3 POM中插件任务配置"></a>5.4.3 POM中插件任务配置</h4><p>除了配置插件的全局参数，我们还可以为某个插件任务配置特定的参数，如输出语句<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">	    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">		    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-antrun-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">			    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;<span class="name">id</span>&gt;</span>ant-validate<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>validate<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">				        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>run<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;<span class="name">configuraction</span>&gt;</span></div><div class="line">					    <span class="tag">&lt;<span class="name">tasks</span>&gt;</span></div><div class="line">						    <span class="tag">&lt;<span class="name">echo</span>&gt;</span>I'm bound to validate phase.<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></div><div class="line">					    <span class="tag">&lt;/<span class="name">tasks</span>&gt;</span></div><div class="line">				    <span class="tag">&lt;/<span class="name">configuraction</span>&gt;</span></div><div class="line">			    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">		    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">	    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="6-聚合与继承"><a href="#6-聚合与继承" class="headerlink" title="6. 聚合与继承"></a>6. 聚合与继承</h2><h3 id="6-1-聚合"><a href="#6-1-聚合" class="headerlink" title="6.1 聚合"></a>6.1 聚合</h3><p>当我们将项目化作多个模块的时候，我们需要使用聚合，聚合模块与其它模块的目录结构通常有水平或者父子两种关系。<br>//TODO：聚合图<br>先来看一下父子目录结构的POM<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.litianming1024<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 聚合模块的打包方式必须为pom --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>moduleA<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>moduleB<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果使用平行目录结构，聚合模块的POM需要做相应的修改<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../moduleA<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../moduleB<span class="tag">&lt;/<span class="name">module</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="6-2-继承"><a href="#6-2-继承" class="headerlink" title="6.2 继承"></a>6.2 继承</h3><p>前面说过所有POM实际都继承自超级POM，使用继承的好处就是减少部分重复配置。<br>要使用继承，首先要先定义父项目的POM<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.litianming1024<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-test-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 父模块的打包方式必须为pom --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>子模块POM修改为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- parent声明父模块,groupId、artifactId、version是必须的 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.litianming1024<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-test-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 默认值../pom.xml --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../maven-test-parent/pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>   </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span> doms-core <span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  ...</div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>Maven会首先根据relativePath检查父POM，如果找不到，再从本地仓库查找。relativePath的默认值为../pom.xml</strong><br><strong>在实际的应用中一个聚合POM可能同时又是父POM，这样管理比较方便</strong></p>
<h4 id="6-2-1-可继承的POM元素"><a href="#6-2-1-可继承的POM元素" class="headerlink" title="6.2.1 可继承的POM元素"></a>6.2.1 可继承的POM元素</h4><ul>
<li>groupId ：项目组 ID ，项目坐标的核心元素；</li>
<li>version ：项目版本，项目坐标的核心元素；</li>
<li>description ：项目的描述信息；</li>
<li>organization ：项目的组织信息；</li>
<li>inceptionYear ：项目的创始年份；</li>
<li>url ：项目的 url 地址</li>
<li>develoers ：项目的开发者信息；</li>
<li>contributors ：项目的贡献者信息；</li>
<li>distributionManagerment ：项目的部署信息；</li>
<li>issueManagement ：缺陷跟踪系统信息；</li>
<li>ciManagement ：项目的持续继承信息；</li>
<li>scm ：项目的版本控制信息；</li>
<li>mailingListserv ：项目的邮件列表信息；</li>
<li>properties ：自定义的 Maven 属性；</li>
<li>dependencies ：项目的依赖配置；</li>
<li>dependencyManagement ：醒目的依赖管理配置；</li>
<li>repositories ：项目的仓库配置；</li>
<li>build ：包括项目的源码目录配置、输出目录配置、插件配置、插件管理配置等；</li>
<li>reporting ：包括项目的报告输出目录配置、报告插件配置等。</li>
</ul>
<h4 id="6-2-2-依赖管理"><a href="#6-2-2-依赖管理" class="headerlink" title="6.2.2 依赖管理"></a>6.2.2 依赖管理</h4><p>由于dependencies也可以被继承，但有时子模块不会用到父模块的所有依赖，这时我们可以使用dependencyManagement元素来管理依赖配置。该元素的依赖声明<strong>不会引入实际的依赖，但是能够约束dependencies下的依赖使用</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 将spring的版本约束在2.5.6 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">springframework.version</span>&gt;</span>2.5.6<span class="tag">&lt;/<span class="name">springframework.version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><span id="import">import：</span><br>如果想要导入合并某个POM中的dependencyManagement配置，我们需要用到import的范围依赖,如<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.litianming1024<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>other<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- type必须为pom --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="6-2-3-插件管理"><a href="#6-2-3-插件管理" class="headerlink" title="6.2.3 插件管理"></a>6.2.3 插件管理</h4><p>Maven也提供了pluginManagement元素帮助管理插件，<strong>该元素不会造成实际的插件调用行为，只是当POM中配置了真正的plugin元素，并且其groupId和artifactId与pluginManagement中配置的插件匹配时才会影响行为</strong>。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="7-使用Maven进行测试"><a href="#7-使用Maven进行测试" class="headerlink" title="7. 使用Maven进行测试"></a>7. 使用Maven进行测试</h2><h3 id="7-1-跳过测试"><a href="#7-1-跳过测试" class="headerlink" title="7.1 跳过测试"></a>7.1 跳过测试</h3><h4 id="7-1-1-仅跳过单元测试"><a href="#7-1-1-仅跳过单元测试" class="headerlink" title="7.1.1 仅跳过单元测试"></a>7.1.1 仅跳过单元测试</h4><p>命令：<code>mvn package -DskipTests</code><br>POM文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="7-1-2-跳过单元测试编译和测试"><a href="#7-1-2-跳过单元测试编译和测试" class="headerlink" title="7.1.2 跳过单元测试编译和测试"></a>7.1.2 跳过单元测试编译和测试</h4><p>命令：<code>mvn package -Dmaven.test.skip=true</code><br>POM文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">        <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="8-灵活构建"><a href="#8-灵活构建" class="headerlink" title="8. 灵活构建"></a>8. 灵活构建</h2><h3 id="8-1-Maven属性"><a href="#8-1-Maven属性" class="headerlink" title="8.1 Maven属性"></a>8.1 Maven属性</h3><p>Maven有6类属性：</p>
<ul>
<li>内置属性：主要两个内置属性——\${basedir}表示项目根目录，即包含pom.xml文件的目录；\${version}标识项目版本。</li>
<li>POM属性：可以使用该类属性引用POM文件中对应元素的值，例如${project.artifactId}对应了\<project>\<artifactid>元素的值<br>常见的POM属性包括：  <pre>
  ${project.build.sourceDirectory}:项目的主源码目录，默认为src/main/java/.
  ${project.build.testSourceDirectory}:项目的测试源码目录，默认为/src/test/java/.
  ${project.build.directory}:项目构建输出目录，默认为target/.
  ${project.build.outputDirectory}:项目主代码编译输出目录，默认为target/classes/.
  ${project.build.testOutputDirectory}:项目测试代码编译输出目录，默认为target/testclasses/.
  ${project.groupId}:项目的groupId.
  ${project.artifactId}:项目的artifactId.
  ${project.version}:项目的version,等同于${version}
  ${project.build.finalName}:项目打包输出文件的名称，默认为${project.artifactId}${project.version}.
  </pre></artifactid></project></li>
<li><p>自定义属性：在POM的\<properties>元素下定义自定义Maven属性。如</properties></p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- swagger.version --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">swagger.version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">swagger.version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>Settings属性：跟pom属性同理，使用setting开头，引用setting.xml文件中xml元素的值</p>
</li>
<li>Java系统属性：所有的java系统属性都可以使用Maven属性引用，如\&amp;{user.home}指向了用户目录</li>
<li>环境变量属性：所有环境变量都可以使用以env.开头的Maven属性引用。如：\${env.JAVAHOME}指代了JAVA_HOME环境变量的值。可以使用<code>mvn help:system</code>来查看所有的环境变量。</li>
</ul>
<h3 id="8-2-构建环境的差异"><a href="#8-2-构建环境的差异" class="headerlink" title="8.2 构建环境的差异"></a>8.2 构建环境的差异</h3><p>在不同的环境中，项目的源码应该使用不同的方式进行构建。最常见的就是数据库配置。</p>
<h3 id="8-3-资源过滤"><a href="#8-3-资源过滤" class="headerlink" title="8.3 资源过滤"></a>8.3 资源过滤</h3><p>为了应对环境的变化，我们需要将会发生变化的部分提取出来。一般会在src/main/resources目录下添加数据库的配置文件.properties文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">database.jdbc.driverClass=$&#123;db.driver&#125;</div><div class="line">database.jdbc.connectionURL=$&#123;db.url&#125;</div><div class="line">database.jdbc.username=$&#123;db.username&#125;</div><div class="line">database.jdbc.password=$&#123;db.password&#125;</div></pre></td></tr></table></figure></p>
<p>我们使用profile在POM中包起来<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span>     </div><div class="line">          <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">db.driver</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">db.driver</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">db.url</span>&gt;</span>jdbc:mysql://192.168.1.100:3306/test<span class="tag">&lt;/<span class="name">db.url</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">db.username</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">db.username</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">db.password</span>&gt;</span>dew-pwd<span class="tag">&lt;/<span class="name">db.password</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>但是这仅仅不够，<strong>Maven属性默认只有在POM中才会被解析</strong>，上面的properties属性仍然没有被填充，为了解决这个问题我们需要定制maven-resources-plugin开启资源过滤<br>为主资源目录开启过滤：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resouces</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>同样为测试资源开启过滤：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">testResources</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/src/test/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">testResouces</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>主资源目录和测试资源目录都可以超过一个<br>属性激活：<code>mvn clean install -Pdev</code> -P参数表示激活的profile</p>
<h3 id="8-4-Maven-Profile"><a href="#8-4-Maven-Profile" class="headerlink" title="8.4 Maven Profile"></a>8.4 Maven Profile</h3><p>在不同环境下的构建很可能是不同的，典型的情况就是数据库的配置。除此之外，有些环境可能需要配置插件执行一些特殊的操作，或者使用特殊版本的依赖，或者需要一个特殊的构件名称。为了能让构建在各个环境下方便地移植，Maven引入了profile的概念。profile能够在构建的时候修改POM的一个子集，或者添加额外的配置元素。用户可以使用很多方式激活profile，以实现构建在不同环境下的移植。</p>
<h4 id="8-4-1-激活profile"><a href="#8-4-1-激活profile" class="headerlink" title="8.4.1 激活profile"></a>8.4.1 激活profile</h4><ol>
<li>命令激活<br>用户可以使用mvn命令行参数-P加上profile的id来激活profile，多个id之间以逗号分隔。例如，下面的命令激活了dev-x和dev-y两个profile：<br><code>mvn clean install -Pdev-x, dev-y</code></li>
<li><p>settings文件显式激活<br>如果用户希望某个profile默认一直处于激活状态，就可以配置settings.xml文件的activeProfiles元素，表示其配置的profile对于所有项目都处于激活状态，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">     ...</div><div class="line">     <span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>dev-x<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>系统属性激活<br>用户可以配置当某系统属性存在或者为特定值的时候自动激活profile，如test为x</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>x<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div><div class="line">``` </div><div class="line"></div><div class="line">不要忘了用户可以在命令行声明系统属性  </div><div class="line">`mvn clean install -Dtest=x`</div><div class="line">   </div><div class="line">4. 操作系统环境激活  </div><div class="line">5. 文件存在与否激活  </div><div class="line">6. 默认激活  </div><div class="line">定义profile的时候指定其默认激活</div><div class="line"></div><div class="line">```xml</div><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">        ...</div><div class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>如果POM中有任何一个profile通过以上其他任意一种方式被激活，所有的默认激活配置都会失效</strong><br>了解当前激活的profile:<code>mvn help:active-profiles</code><br>列出当前所有的profile:<code>mvn help:all-profiles</code></p>
<h4 id="8-4-2-profile的种类"><a href="#8-4-2-profile的种类" class="headerlink" title="8.4.2 profile的种类"></a>8.4.2 profile的种类</h4><p>根据具体的需要，可以在以下位置声明profile：</p>
<ul>
<li>pom.xml：pom.xml中声明的profile只对当前项目有效。</li>
<li>用户settings.xml：用户目录下.m2/settings.xml中的profile对本机上该用户所有的Maven项目有效。</li>
<li>全局settings.xml：Maven安装目录下conf/settings.xml中的profile对本机上所有的Maven项目有效，不建议使用。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>《Maven实战》</li>
<li><a href="http://ifeve.com/introduction-to-optional-and-excludes-dependencies/" target="_blank" rel="external">Maven官方指南</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2017/12/05/MySQL自定义变量小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/MySQL自定义变量小结/" itemprop="url">MySQL自定义变量小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T16:59:32+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/12/05/MySQL自定义变量小结/" class="leancloud_visitors" data-flag-title="MySQL自定义变量小结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近阅读《高性能MySQL》，有不少收获。用户自定义变量是一个可以用来存储内容的临时容器，在连接MySQL的整个过程中都存在。下面的话大部分是从书上搬下来的。</p>
<h1 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h1><p>有些场景我们不能使用自定义变量</p>
<ul>
<li>使用自定义变量的查询，无法使用查询缓存</li>
<li>不能在使用常量或者标识符的地方使用自定义变量，例如表名、列名、和LIMIT子句中</li>
<li>用户自定义变量的生命周期是在一个连接中有效，所以不能用它们来做连接间的通信</li>
<li>如果使用连接池或者持久话连接，自定义变量可能让看起来毫无关系的代码发生交互（如果是这样，通常是代码bug或者连接池bug，这类情况确实可能发生，前面是书上原话，此处存疑）</li>
<li>在5.0之前的版本，是大小写敏感的，所以要注意代码在不同MySQL版本间的兼容性问题</li>
<li>不能显示地声明自定义变量的类型。确定未定义变量的具体类型的时机在不同MySQL版本中也可能不一样。用户自定义变量的类型在赋值的时候会改变，MySQL的用户自定义变量是一个动态类型，最好定义时就赋初值</li>
<li>MySQL优化器在某些场景下可能会将这些变量优化掉，这可能导致代码不按预想的方式运行</li>
<li>复制的顺序和赋值的时间点并不总是固定的，这依赖于优化器的决定。实际情况可能很让人困惑</li>
<li>赋值符号:=的优先级非常低，所以需要注意，赋值表达式应该使用明确的括号</li>
<li>使用未定义变量不会产生任何语法错误</li>
</ul>
<h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><h2 id="1-优化排名语句"><a href="#1-优化排名语句" class="headerlink" title="1.优化排名语句"></a>1.优化排名语句</h2><p>用户自定义变量可以在给一个变量赋值的同时使用这个变量。用户自定义变量具有“左值”的特性。<br>来简单的实现一个rownumber的功能：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SET @rownum := 0;</div><div class="line">SELECT actor_id, @rownum := @rownum + 1 AS rownum FROM actor;</div></pre></td></tr></table></figure></p>
<p>书中还给了一个复杂的例子来演示排名的写法，Leetcode的练习题中也有类似例子<a href="https://leetcode.com/problems/rank-scores/description/" target="_blank" rel="external">178. Rank Scores</a></p>
<h2 id="2-避免重复查询刚刚更新的数据"><a href="#2-避免重复查询刚刚更新的数据" class="headerlink" title="2.避免重复查询刚刚更新的数据"></a>2.避免重复查询刚刚更新的数据</h2><p>例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UPDATE t1 SET lastUpdated = NOW() WHERE id = 1;</div><div class="line">SELECT lastUpdated FROM t1 FROM id = 1;</div></pre></td></tr></table></figure></p>
<p>使用变量，可以改写为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UPDATE t1 SET lastUpdated = NOW() WHERE id = 1 AND @now := NOW();</div><div class="line">SELECT @now;</div></pre></td></tr></table></figure></p>
<p>改写后仍需要两个查询，需要两次网络来回，但是无需访问任何数据表</p>
<h2 id="3-统计更新和插入的数量"><a href="#3-统计更新和插入的数量" class="headerlink" title="3.统计更新和插入的数量"></a>3.统计更新和插入的数量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">INSERT INTO t1(c1, c2) VALUES(4, 4), (2,1), (3,1) ON DUPLICATE KEY UPDATE c1 = VALUES(c1) + (0 * (@x := @x + 1));</div></pre></td></tr></table></figure>
<p>这个写法十分巧妙，每次由于冲突导致更新时对变量@x自增一次，然后再乘0来避免影响要更新的内容。同时MySQL的协议会返回被更改的总行数，所以不需要单独统计这个值。</p>
<h2 id="4-确定取值的顺序"><a href="#4-确定取值的顺序" class="headerlink" title="4.确定取值的顺序"></a>4.确定取值的顺序</h2><p>用户自定义变量的一个最常见问题是没有注意到在赋值和读取变量的时候可能是在查询的不同阶段。<br>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SET @rownum := 0;</div><div class="line">SELECT actor_id, @rownum := @rownum + 1 as cnt</div><div class="line">FROM actor</div><div class="line">WHERE @rownum &lt;= 1</div></pre></td></tr></table></figure></p>
<p>结果只返回了两条结果，似乎符合预期（实际读取变量和赋值不在同一阶段，但是没有影响到结果）。而<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SET @rownum := 0;</div><div class="line">SELECT actor_id, @rownum := @rownum + 1 as cnt</div><div class="line">FROM actor</div><div class="line">WHERE @rownum &lt;= 1</div><div class="line">ORDER BY first_name;</div></pre></td></tr></table></figure></p>
<p>却返回了200条结果，而且有cnt超过1的条目，通过explain语句我们发现<br><br>using filesort是造成这个问题的原因，WHERE条件是在文件排序操作之前取值的（ORDER BY导致一次性选取了所有满足WHERE条件的语句，换句话说，WHERE处的@rownum只读取了一次，值为0，所有数据都符合条件，WHERE执行在SELECT之前，之后不停给@rownum赋新值，我是这样理解的）。如果first_name有索引则结果正常，使用了覆盖索引并且没有触发filesort。</p>
<h2 id="5-编写偷懒的UNION"><a href="#5-编写偷懒的UNION" class="headerlink" title="5.编写偷懒的UNION"></a>5.编写偷懒的UNION</h2><p>下面的查询会在两个地方查找一个用户——一个用户表，一个长时间不活跃的用户表，不活跃的用户表的目的是为了实现更高效的归档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SELECT id FROM users WHERE id = 123</div><div class="line">UNION ALL</div><div class="line">SELECT id FROM users_archived WHERE id = 123;</div></pre></td></tr></table></figure></p>
<p>上面的查询即使在users表中已经找到了记录，也还是会去users_archived中再查找一次。我们可以用UNION查询来抑制，只有当第一个表中没有数据时，才在第二个表中查询。只要在第一个表中找到记录就定义一个变量@found通过在结果列中做一次赋值来实现，然后将赋值放在函数GREATEST中来避免返回额外的数据。为了明确结果来自哪一个表，新增了一个包含表名的列。最后需要在查询的末尾将变量重置为NULL，保证遍历时不干扰后面的结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SELECT GREATEST(@found := −1, id) AS id, &apos;users&apos; AS which_tbl</div><div class="line">FROM users WHERE id = 1</div><div class="line">UNION ALL</div><div class="line">SELECT id, &apos;users_archived&apos;FROM users_archived WHERE id = 1 AND @found IS NULL</div><div class="line">UNION ALL</div><div class="line">SELECT 1, &apos;reset&apos; FROM DUAL WHERE ( @found := NULL ) IS NOT NULL;</div></pre></td></tr></table></figure></p>
<h2 id="6-用户自定义变量的其他用处"><a href="#6-用户自定义变量的其他用处" class="headerlink" title="6.用户自定义变量的其他用处"></a>6.用户自定义变量的其他用处</h2><ul>
<li>查询运行是计算总数和平均值</li>
<li>模拟GROUP语句中的函数FITST()和LAST()</li>
<li>对大量数据做一些数据计算</li>
<li>计算一个大表的MD5散列值</li>
<li>编写一个样本处理函数，当样本中的数值超过某个边界值的时候将其变成0</li>
<li>模拟读/写游标</li>
<li>在SHOW语句的WHERE子句中加入变量值</li>
</ul>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7.总结"></a>7.总结</h2><p>先了解SQL语句的执行顺序才能读懂这部分，其他用处我还没有试验。</p>
<h2 id="8-参考资料"><a href="#8-参考资料" class="headerlink" title="8.参考资料"></a>8.参考资料</h2><p>《高性能MySQL》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2017/10/17/我的校招之路才刚刚开始/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/17/我的校招之路才刚刚开始/" itemprop="url">我的校招之路才刚刚开始</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-17T11:07:18+08:00">
                2017-10-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/10/17/我的校招之路才刚刚开始/" class="leancloud_visitors" data-flag-title="我的校招之路才刚刚开始">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>经历了一些努力，拿到了好几家大公司的面试，已经到了TMD之流，复习的第一阶段目标已经基本达成。不论如何轮到我展现真正实力的时候到了。最近每一天都要面试，来不及写更多，对于面试的复盘我会在接下来进行记录。还要再复习。哈哈哈哈。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2017/09/24/SQL语句执行顺序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/24/SQL语句执行顺序/" itemprop="url">SQL语句执行顺序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-24T23:07:11+08:00">
                2017-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/24/SQL语句执行顺序/" class="leancloud_visitors" data-flag-title="SQL语句执行顺序">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>SQL语句执行顺序是面试中的基础考点，理解SQL对于优化排错有重大的作用,这里从两篇文章摘取部分重要的内容</p>
<h1 id="SQL查询步骤"><a href="#SQL查询步骤" class="headerlink" title="SQL查询步骤"></a>SQL查询步骤</h1><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(8)SELECT (9) DISTINCT (11) &lt;TOP_specification&gt; &lt;select_list&gt;</div><div class="line">(1) FROM &lt;left_table&gt;</div><div class="line">(3) &lt;join_type&gt; JOIN &lt;right_table&gt;</div><div class="line">(2) ON &lt;join_condition&gt;</div><div class="line">(4) WHERE &lt;where_condition&gt;</div><div class="line">(5) GROUP BY &lt;group_by_list&gt;</div><div class="line">(6) WITH &#123;CUBE | ROLLUP&#125;</div><div class="line">(7) HAVING &lt;having_condition&gt;</div><div class="line">(10) ORDER BY &lt;order_by_list&gt;</div></pre></td></tr></table></figure>
<p>这是对语句执行顺序的基本总结</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ol>
<li>FROM：对FROM子句中的前两个表执行笛卡尔积(交叉联接)，生成虚拟表VT1。</li>
<li>ON：对VT1应用ON筛选器，只有那些使为真才被插入到VT2。</li>
<li>OUTER (JOIN):如果指定了OUTER JOIN(相对于CROSS JOIN或INNER JOIN)，保留表中未找到匹配的行将作为外部行添加到VT2，生成VT3。如果FROM子句包含两个以上的表，则对上一个联接生成的结果表和下一个表重复执行步骤1到步骤3，直到处理完所有的表位置。</li>
<li>WHERE：对VT3应用WHERE筛选器，只有使为true的行才插入VT4。</li>
<li>GROUP BY：按GROUP BY子句中的列列表对VT4中的行进行分组，生成VT5。</li>
<li>CUTE|ROLLUP：把超组插入VT5，生成VT6。</li>
<li>HAVING：对VT6应用HAVING筛选器，只有使为true的组插入到VT7。</li>
<li>SELECT：处理SELECT列表，产生VT8。</li>
<li>DISTINCT：将重复的行从VT8中删除，产品VT9。</li>
<li>ORDER BY：将VT9中的行按ORDER BY子句中的列列表顺序，生成一个游标(VC10)。</li>
<li>TOP：从VC10的开始处选择指定数量或比例的行，生成表VT11，并返回给调用者。</li>
</ol>
<h1 id="引用文章"><a href="#引用文章" class="headerlink" title="引用文章"></a>引用文章</h1><p><a href="http://www.jianshu.com/p/bb19b6b0fdc3" target="_blank" rel="external">sql语句执行顺序</a><br><a href="http://www.jellythink.com/archives/924" target="_blank" rel="external">SQL逻辑查询语句执行顺序</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2017/09/23/索引失效情况总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/23/索引失效情况总结/" itemprop="url">索引失效情况总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-23T22:38:01+08:00">
                2017-09-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/23/索引失效情况总结/" class="leancloud_visitors" data-flag-title="索引失效情况总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>非常意外的收到了京东的面试，面试小姐姐问到了索引失效的情况，这是个很基础的问题，在这里做一下简单的总结，至于背后的原理会在后面解释。</p>
<h1 id="索引失效的情况"><a href="#索引失效的情况" class="headerlink" title="索引失效的情况"></a>索引失效的情况</h1><h2 id="1-查询条件包含or"><a href="#1-查询条件包含or" class="headerlink" title="1.查询条件包含or"></a>1.查询条件包含or</h2><p>如果查询条件包含or时，可能导致索引失效。<br>当or左右查询字段只有一个是索引，该索引失效，只有当or左右查询字段均为索引时，才会生效。</p>
<h2 id="2-like查询以-开头"><a href="#2-like查询以-开头" class="headerlink" title="2.like查询以%开头"></a>2.like查询以%开头</h2><p>使用like模糊查询，当%在前时索引失效。</p>
<h2 id="3-如果列类型是字符串，where时一定要用引号括起来，否则索引失效"><a href="#3-如果列类型是字符串，where时一定要用引号括起来，否则索引失效" class="headerlink" title="3.如果列类型是字符串，where时一定要用引号括起来，否则索引失效"></a>3.如果列类型是字符串，where时一定要用引号括起来，否则索引失效</h2><h2 id="4-如果mysql估计使用全表扫描比使用索引快，则索引失效"><a href="#4-如果mysql估计使用全表扫描比使用索引快，则索引失效" class="headerlink" title="4.如果mysql估计使用全表扫描比使用索引快，则索引失效"></a>4.如果mysql估计使用全表扫描比使用索引快，则索引失效</h2><h2 id="5-最左前缀匹配原则"><a href="#5-最左前缀匹配原则" class="headerlink" title="5.最左前缀匹配原则"></a>5.最左前缀匹配原则</h2><p>这条是最为复杂的，这里直接引用美团的文章<br>1.最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配，比如a = 1 and b = 2 and c &gt; 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。<br>2.=和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式。</p>
<h2 id="6-对索引列进行运算导致索引失效"><a href="#6-对索引列进行运算导致索引失效" class="headerlink" title="6.对索引列进行运算导致索引失效"></a>6.对索引列进行运算导致索引失效</h2><p>对索引列进行运算包括(+，-，*，/，! 等)，如 where id - 1 = 1;</p>
<h2 id="7-索引不会包含有NULL值的列"><a href="#7-索引不会包含有NULL值的列" class="headerlink" title="7.索引不会包含有NULL值的列"></a>7.索引不会包含有NULL值的列</h2><p>只要列中包含有NULL值都将不会被包含在索引中，复合索引中只要有一列含有NULL值，那么这一列对于此复合索引就是无效的。所以我们在数据库设计时不要让字段的默认值为NULL。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上只是可能的集中情况，根据数据库引擎和索引的类别情况可能有所不同。如果对是否使用到索引有疑问，一定要使用explain检查索引是否失效！<br>一定要使用explain检查索引是否失效！<br>一定要使用explain检查索引是否失效！<br>对于如何怎样建立合适的索引我会另做讨论</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://litianming1024.github.io/2017/09/15/TCP拥塞控制-经典算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天明的小窝">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/15/TCP拥塞控制-经典算法/" itemprop="url">TCP拥塞控制-经典算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-15T08:41:58+08:00">
                2017-09-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/15/TCP拥塞控制-经典算法/" class="leancloud_visitors" data-flag-title="TCP拥塞控制-经典算法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><blockquote>
<p>路由器因无法处理高速率到达的流量而被迫丢弃数据信息的现象称为拥塞。当路由器处于上述状态时，我们就说出现了拥塞。即使仅有一条通信连接，也可能造成一个甚至多个路由器阻塞。若不采取对策，网络性能将大受影响以致瘫痪。在最坏情况下，甚至形成拥塞崩溃。为了避免或在一定程度上缓解这种状况，TCP通信的每一方实行拥塞控制机制。不同的TCP版本采取的规程和行为有所差异。</p>
</blockquote>
<p>上面是《TCP/IP详解卷1》对于拥塞控制的引言，相比《计算机网络-自顶向下》，《TCP/IP详解卷1》更为详细的讲述了不同种的算法原理。入门可以先从《计算机网络-自顶向下》读起，有个大致了解便可以，如果感兴趣再读《TCP/IP详解卷1》。<br>简单概括，拥塞控制包含3个方面：慢启动、拥塞避免、快速恢复。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>在开始之前有几个概念要了解<br>拥塞窗口（congestion window）：记为cwnd，拥塞控制的关键参数，它描述源端在拥塞控制情况下一次最多能发送的数据包的数量。<br>慢启动阈值（slow start threshold）：记为ssthres，拥塞控制中慢启动阶段和拥塞避免阶段的分界点。</p>
<h2 id="慢启动"><a href="#慢启动" class="headerlink" title="慢启动"></a>慢启动</h2><p>开始时，cwnd的值一般为1个MSS，发送端按照cwnd大小发送数据，在接收到一个数据段的ACK后，cwnd就增加一个MSS大小。cwnd的值会随着RTT呈指数增长。<br>例如，cwnd初始为1,接收到一个数据段的ACK后，cwnd增长到2,接着会发送两个数据段。如果成功接收到相应的新的ACK，cwnd会由2增长为4,以此类推。<br>结束：慢启动的结束有3种方式。  </p>
<ol>
<li>当cwnd的增长到达ssthresh，就进入拥塞避免模式。</li>
<li>如果收到了了一个丢包提示，就将ssthresh的值设置为cwnd的一半，并将cwnd设置为1,重新进入慢启动过程。</li>
<li>当收到3个重复的ACK，就执行一次快速重传并且进入快速恢复状态。</li>
</ol>
<h2 id="拥塞避免"><a href="#拥塞避免" class="headerlink" title="拥塞避免"></a>拥塞避免</h2><p>进入拥塞避免说明cwnd的值大约是上次遇到拥塞时的一半，这时不能盲目翻倍，而是每经过1个RTT使cwnd增加1个MSS。也就是说当收到一个ACK时，cwnd = cwnd + 1/cwnd，当每过一个RTT时，cwnd = cwnd + 1。<br>结束：拥塞避免的结束有两种可能。  </p>
<ol>
<li>当出现超时时，将ssthresh设置为当前cwnd值的一半，cwnd设置为1,重新进入慢启动过程。  </li>
<li>当收到3个重复的ACK时，把ssthresh设置为cwnd的一半，再把cwnd设置为ssthresh（某些实现为ssthresh + 3），之后进入快速恢复。  </li>
</ol>
<h2 id="快速恢复"><a href="#快速恢复" class="headerlink" title="快速恢复"></a>快速恢复</h2><p>快速恢复就是指进入快速恢复前的一系列操作，即sssthresh设置为当前cwnd的一半，并将cwnd设置为ssthresh（某些版本为ssthresh + 3），之后进入拥塞避免状态。  </p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>《计算机网络-自顶向下》</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">天明</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/litianming1024" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">天明</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        


<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "https://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500527581");

  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=63752005";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("jiHfwcJtEphKAriEGeMG8IYq-gzGzoHsz", "XPJ6sD8gmhxHgptIOe9rtgCK");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
